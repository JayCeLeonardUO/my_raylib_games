#!/usr/bin/env python3
"""
Convert images to GLB textured planes.

Usage:
    img2glb <input> <output_dir>
    img2glb <input_dir> <output_dir>

Examples:
    img2glb texture.png ./assets/glb_output
    img2glb ./assets/textures ./assets/glb_output

Requires Blender to be installed and in PATH.
"""

import subprocess
import sys
import os
import shutil
from pathlib import Path

SCRIPT_DIR = Path(__file__).parent
BLENDER_SCRIPT = SCRIPT_DIR / "images_to_glb.py"


def find_blender():
    """Find Blender executable."""
    # Check common locations
    locations = [
        shutil.which("blender"),
        "/usr/bin/blender",
        "/usr/local/bin/blender",
        os.path.expanduser("~/blender/blender"),
        "/opt/blender/blender",
    ]

    # Check for versioned blender in home directory
    home = Path.home()
    for p in home.glob("blender-*/blender"):
        locations.append(str(p))

    for loc in locations:
        if loc and os.path.isfile(loc) and os.access(loc, os.X_OK):
            return loc

    return None


def convert_single_image(image_path: str, output_dir: str, blender_path: str):
    """Convert a single image to GLB."""
    os.makedirs(output_dir, exist_ok=True)

    # Create a temporary script for single image conversion
    image_name = Path(image_path).stem
    output_path = os.path.join(output_dir, f"{image_name}.glb")

    cmd = [
        blender_path,
        "--background",
        "--python", str(BLENDER_SCRIPT),
        "--",
        os.path.dirname(image_path) or ".",
        output_dir,
    ]

    # For single file, we'll use a modified approach
    single_script = f'''
import bpy
import sys
sys.path.insert(0, "{SCRIPT_DIR}")
from images_to_glb import clear_scene, create_textured_plane, export_to_glb
import os

clear_scene()
plane = create_textured_plane("{image_path}", "{image_name}")
plane.select_set(True)
export_to_glb("{output_path}")
print("Converted: {image_path} -> {output_path}")
'''

    cmd = [
        blender_path,
        "--background",
        "--python-expr", single_script,
    ]

    result = subprocess.run(cmd, capture_output=True, text=True)

    if result.returncode != 0:
        print(f"Error: {result.stderr}", file=sys.stderr)
        return False

    print(f"Created: {output_path}")
    return True


def convert_directory(input_dir: str, output_dir: str, blender_path: str):
    """Convert all images in a directory to GLBs."""
    cmd = [
        blender_path,
        "--background",
        "--python", str(BLENDER_SCRIPT),
        "--",
        input_dir,
        output_dir,
    ]

    result = subprocess.run(cmd)
    return result.returncode == 0


def main():
    if len(sys.argv) < 3:
        print(__doc__)
        sys.exit(1)

    input_path = sys.argv[1]
    output_dir = sys.argv[2]

    # Find Blender
    blender = find_blender()
    if not blender:
        print("Error: Blender not found. Please install Blender or add it to PATH.")
        print("You can also set BLENDER_PATH environment variable.")
        sys.exit(1)

    print(f"Using Blender: {blender}")

    if os.path.isfile(input_path):
        # Single image
        success = convert_single_image(input_path, output_dir, blender)
    elif os.path.isdir(input_path):
        # Directory
        success = convert_directory(input_path, output_dir, blender)
    else:
        print(f"Error: Input not found: {input_path}")
        sys.exit(1)

    sys.exit(0 if success else 1)


if __name__ == "__main__":
    main()
